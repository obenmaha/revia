name: ğŸ” Security - Secrets Scan

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  schedule:
    # Scan quotidien Ã  2h du matin
    - cron: '0 2 * * *'

jobs:
  secrets-scan:
    name: ğŸ” Scan des secrets
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NÃ©cessaire pour gitleaks

      - name: ğŸ” Install Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml

      - name: ğŸš¨ Scan des secrets
        run: |
          echo "ğŸ” DÃ©marrage du scan des secrets..."
          gitleaks detect --config .gitleaks.toml --verbose --redact

      - name: ğŸ“Š Rapport de sÃ©curitÃ©
        if: always()
        run: |
          echo "ğŸ“Š Scan des secrets terminÃ©"
          echo "âœ… Aucun secret dÃ©tectÃ©" || echo "âŒ Secrets dÃ©tectÃ©s - VÃ©rifiez les logs ci-dessus"

  env-validation:
    name: ğŸ›¡ï¸ Validation des variables d'environnement
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run security tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests de sÃ©curitÃ© des variables d'environnement..."
          npm run test src/test/env-security.test.ts

      - name: ğŸ—ï¸ Test build with security checks
        run: |
          echo "ğŸ—ï¸ Test de build avec vÃ©rifications de sÃ©curitÃ©..."
          npm run build

      - name: ğŸ“‹ VÃ©rification des templates
        run: |
          echo "ğŸ“‹ VÃ©rification des templates d'environnement..."
          if grep -q "YOUR-PROJECT-ID" env.local.example; then
            echo "âœ… Template env.local.example sÃ©curisÃ©"
          else
            echo "âŒ Template env.local.example contient des vraies clÃ©s !"
            exit 1
          fi

          if grep -q "YOUR-ANON-KEY-HERE" env.local.example; then
            echo "âœ… Placeholders corrects dans env.local.example"
          else
            echo "âŒ Placeholders manquants dans env.local.example"
            exit 1
          fi
