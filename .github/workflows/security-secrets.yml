name: 🔐 Security - Secrets Scan

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  schedule:
    # Scan quotidien à 2h du matin
    - cron: '0 2 * * *'

jobs:
  secrets-scan:
    name: 🔍 Scan des secrets
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Nécessaire pour gitleaks

      - name: 🔍 Install Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml

      - name: 🚨 Scan des secrets
        run: |
          echo "🔍 Démarrage du scan des secrets..."
          gitleaks detect --config .gitleaks.toml --verbose --redact

      - name: 📊 Rapport de sécurité
        if: always()
        run: |
          echo "📊 Scan des secrets terminé"
          echo "✅ Aucun secret détecté" || echo "❌ Secrets détectés - Vérifiez les logs ci-dessus"

  env-validation:
    name: 🛡️ Validation des variables d'environnement
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🧪 Run security tests
        run: |
          echo "🧪 Exécution des tests de sécurité des variables d'environnement..."
          npm run test src/test/env-security.test.ts

      - name: 🏗️ Test build with security checks
        run: |
          echo "🏗️ Test de build avec vérifications de sécurité..."
          npm run build

      - name: 📋 Vérification des templates
        run: |
          echo "📋 Vérification des templates d'environnement..."
          if grep -q "YOUR-PROJECT-ID" env.local.example; then
            echo "✅ Template env.local.example sécurisé"
          else
            echo "❌ Template env.local.example contient des vraies clés !"
            exit 1
          fi

          if grep -q "YOUR-ANON-KEY-HERE" env.local.example; then
            echo "✅ Placeholders corrects dans env.local.example"
          else
            echo "❌ Placeholders manquants dans env.local.example"
            exit 1
          fi
