# Story 1.5: Historique et Statistiques

## Status

Draft

## Story

**En tant qu'** utilisateur sportif,  
**Je veux** consulter mon historique et mes statistiques,  
**Afin de** suivre ma progression dans le temps.

## Acceptance Criteria

1. Historique chronologique des séances avec filtres
2. Statistiques de fréquence, durée et tendance RPE
3. Interface de visualisation des données
4. Export des données en CSV/PDF

## Tasks / Subtasks

- [ ] Créer l'interface d'historique des séances (AC: 1)
  - [ ] Liste chronologique des séances avec pagination
  - [ ] Filtres par période (semaine, mois, année)
  - [ ] Filtres par type de séance (cardio, musculation, etc.)
  - [ ] Filtres par statut (complétée, en cours, brouillon)
  - [ ] Recherche par nom de séance
  - [ ] Tri par date, durée, type
- [ ] Implémenter les statistiques de progression (AC: 2)
  - [ ] Calcul de la fréquence hebdomadaire
  - [ ] Calcul de la durée totale des séances
  - [ ] Calcul de la tendance RPE moyenne
  - [ ] Calcul des streaks (jours consécutifs)
  - [ ] Graphiques de progression temporelle
  - [ ] Métriques de performance par type d'exercice
- [ ] Développer l'interface de visualisation (AC: 3)
  - [ ] Dashboard avec statistiques principales
  - [ ] Graphiques interactifs (ligne, barre, circulaire)
  - [ ] Cartes de métriques avec indicateurs visuels
  - [ ] Vue détaillée des séances individuelles
  - [ ] Comparaison de périodes
- [ ] Implémenter l'export des données (AC: 4)
  - [ ] Export CSV avec toutes les données
  - [ ] Export PDF avec rapport formaté
  - [ ] Filtres d'export par période
  - [ ] Inclusion des métadonnées et mentions légales
  - [ ] Gestion des données sensibles (RGPD)

## Dev Notes

### Architecture Context

[Source: docs/architecture/03-data-models.md#sportsession]

**Stack Frontend :**
- React 19 + TypeScript + Vite
- TanStack Query v5 pour la gestion d'état serveur
- Radix UI + Tailwind CSS pour l'interface
- Recharts pour les graphiques interactifs
- React Hook Form + Zod pour les formulaires
- Zustand pour l'état global

**Modèles de données :**

```typescript
// SportSession - Séances d'entraînement
interface SportSession {
  id: string;
  user_id: string;
  name: string;
  date: Date;
  type: 'cardio' | 'musculation' | 'flexibility' | 'other';
  status: 'draft' | 'in_progress' | 'completed';
  objectives: string;
  notes: string;
  rpe_score: number; // 1-10
  pain_level: number; // 1-10
  duration_minutes: number;
  created_at: string;
  updated_at: string;
}

// SportExercise - Exercices dans une séance
interface SportExercise {
  id: string;
  session_id: string;
  name: string;
  exercise_type: string;
  sets: number;
  reps: number;
  weight_kg: number;
  duration_seconds: number;
  rest_seconds: number;
  order_index: number;
  notes: string;
}

// SportStats - Statistiques calculées
interface SportStats {
  total_sessions: number;
  weekly_frequency: number;
  total_duration_minutes: number;
  average_rpe: number;
  current_streak: number;
  best_streak: number;
  sessions_by_type: Record<string, number>;
  monthly_progression: MonthlyStats[];
}

interface MonthlyStats {
  month: string;
  sessions_count: number;
  total_duration: number;
  average_rpe: number;
  streak: number;
}
```

**Structure de composants :**

```
src/components/features/sport/
├── SportHistory/
│   ├── SportHistoryPage.tsx          # Page principale
│   ├── SportSessionList.tsx          # Liste des séances
│   ├── SportSessionCard.tsx          # Carte de séance
│   ├── SportHistoryFilters.tsx       # Filtres de recherche
│   └── SportHistoryPagination.tsx    # Pagination
├── SportStatistics/
│   ├── SportStatsDashboard.tsx       # Dashboard principal
│   ├── SportStatsCards.tsx           # Cartes de métriques
│   ├── SportStatsCharts.tsx          # Graphiques
│   └── SportStatsComparison.tsx      # Comparaison de périodes
└── SportExport/
    ├── SportExportModal.tsx          # Modal d'export
    ├── SportCSVExport.tsx            # Export CSV
    └── SportPDFExport.tsx            # Export PDF
```

**Hooks spécialisés :**

```typescript
// Hook pour l'historique des séances
function useSportHistory(filters: HistoryFilters) {
  return {
    sessions: SportSession[];
    totalCount: number;
    isLoading: boolean;
    error: Error | null;
    refetch: () => void;
  };
}

// Hook pour les statistiques
function useSportStats(period: 'week' | 'month' | 'year') {
  return {
    stats: SportStats;
    isLoading: boolean;
    error: Error | null;
  };
}

// Hook pour l'export
function useSportExport() {
  return {
    exportCSV: (filters: ExportFilters) => Promise<void>;
    exportPDF: (filters: ExportFilters) => Promise<void>;
    isExporting: boolean;
  };
}
```

**Requêtes Supabase optimisées :**

```typescript
// Récupération de l'historique avec filtres
const getSportHistory = async (filters: HistoryFilters) => {
  const { data: sessions } = await supabase
    .from('sport_sessions')
    .select(`
      *,
      sport_exercises (
        id, name, exercise_type, sets, reps, weight_kg, 
        duration_seconds, order_index
      )
    `)
    .eq('user_id', userId)
    .gte('date', filters.startDate)
    .lte('date', filters.endDate)
    .order('date', { ascending: false })
    .range(filters.offset, filters.offset + filters.limit - 1);
    
  return sessions;
};

// Calcul des statistiques
const getSportStats = async (period: string) => {
  const { data: sessions } = await supabase
    .from('sport_sessions')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'completed')
    .gte('date', getPeriodStart(period));
    
  return calculateStats(sessions);
};
```

**Graphiques et visualisations :**

```typescript
// Configuration Recharts pour les graphiques
const chartConfig = {
  progression: {
    type: 'line',
    dataKey: 'sessions_count',
    xAxis: 'month',
    yAxis: 'Séances',
    color: '#2563EB'
  },
  types: {
    type: 'pie',
    dataKey: 'count',
    nameKey: 'type',
    colors: ['#2563EB', '#059669', '#7C3AED', '#F59E0B']
  },
  rpe: {
    type: 'bar',
    dataKey: 'average_rpe',
    xAxis: 'week',
    yAxis: 'RPE Moyen',
    color: '#7C3AED'
  }
};
```

### Testing Standards

[Source: docs/architecture/04-component-architecture.md#testing-requirements]

**Tests unitaires (Vitest) :**
- Calculs de statistiques (fréquence, durée, RPE)
- Filtres et tri des séances
- Formatage des données d'export
- Hooks personnalisés (useSportHistory, useSportStats)
- Composants de visualisation

**Tests d'intégration :**
- Récupération des données depuis Supabase
- Application des filtres et pagination
- Génération des exports CSV/PDF
- Mise à jour des statistiques en temps réel

**Tests E2E (Playwright) :**
- Flux complet de consultation de l'historique
- Filtrage et recherche de séances
- Export des données
- Responsive design sur mobile

**Configuration des tests :**
- Tests dans `src/__tests__/sport/`
- Mocks pour Supabase et les exports
- Données de test réalistes
- Tests de performance pour les calculs

### File Locations

- Page historique : `src/pages/sport/SportHistoryPage.tsx`
- Composants : `src/components/features/sport/SportHistory/`
- Composants stats : `src/components/features/sport/SportStatistics/`
- Composants export : `src/components/features/sport/SportExport/`
- Hooks : `src/hooks/useSportHistory.ts`, `src/hooks/useSportStats.ts`
- Services : `src/services/sportHistoryService.ts`
- Utils : `src/utils/sportStats.ts`, `src/utils/exportUtils.ts`
- Types : `src/types/sport.ts`

### Technical Constraints

- React 19 avec TypeScript strict
- TanStack Query pour la gestion d'état serveur
- Radix UI pour les composants accessibles
- Recharts pour les graphiques interactifs
- Support des exports CSV/PDF
- Conformité RGPD pour les exports
- Performance optimisée pour les grandes quantités de données
- Interface responsive mobile-first

## Change Log

| Date       | Version | Description                    | Author      |
| ---------- | ------- | ------------------------------ | ----------- |
| 2025-01-14 | 1.0     | Création initiale de la story | Bob (SM)    |

## Dev Agent Record

### Agent Model Used

*À remplir par l'agent de développement*

### Debug Log References

*À remplir par l'agent de développement*

### Completion Notes List

*À remplir par l'agent de développement*

### File List

*À remplir par l'agent de développement*

## QA Results

### Review Date: 2025-01-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**ÉVALUATION GLOBALE : CONCERNS**

L'histoire 1.5 présente une architecture bien pensée mais une implémentation incomplète. Bien que la structure des composants et les modèles de données soient bien définis, l'implémentation actuelle se limite à des données mockées sans intégration réelle avec Supabase. Les fonctionnalités critiques d'export et de visualisation ne sont pas implémentées.

### Refactoring Performed

Aucun refactoring effectué - l'histoire nécessite une implémentation complète avant refactoring.

### Compliance Check

- **Coding Standards**: ✗ - Code non implémenté, données mockées uniquement
- **Project Structure**: ✓ - Structure des composants respectée
- **Testing Strategy**: ✗ - Aucun test spécifique pour les fonctionnalités d'historique/statistiques
- **All ACs Met**: ✗ - Fonctionnalités non implémentées

### Improvements Checklist

- [ ] Implémenter l'intégration réelle avec Supabase (remplacer les données mockées)
- [ ] Créer les hooks useSportHistory, useSportStats, useSportExport
- [ ] Implémenter les composants de visualisation avec Recharts
- [ ] Développer les fonctionnalités d'export CSV/PDF
- [ ] Ajouter les tests unitaires pour les calculs de statistiques
- [ ] Ajouter les tests d'intégration pour les requêtes Supabase
- [ ] Implémenter la pagination et les filtres avancés
- [ ] Créer les composants SportStatistics et SportExport
- [ ] Aligner les modèles de données avec les types existants
- [ ] Implémenter la gestion des erreurs et états de chargement

### Security Review

**CONCERNS** - Pas de validation des données d'export, risque d'exposition de données sensibles lors des exports CSV/PDF. Nécessite une implémentation de la conformité RGPD.

### Performance Considerations

**CONCERNS** - Les calculs de statistiques sur de grandes quantités de données pourraient impacter les performances. Nécessite une optimisation des requêtes Supabase et une pagination efficace.

### Files Modified During Review

Aucun fichier modifié - implémentation requise.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.5-historique-et-statistiques.yml
Risk profile: docs/qa/assessments/1.5-risk-20250114.md
NFR assessment: docs/qa/assessments/1.5-nfr-20250114.md

### Recommended Status

✗ Changes Required - Voir les éléments non cochés ci-dessus
