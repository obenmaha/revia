# Story 1.6: Gamification et Rappels

## Status

Ready for Development

## Story

**En tant qu'** utilisateur sportif,
**Je veux** √™tre motiv√© par la gamification et recevoir des rappels,
**Afin de** maintenir ma r√©gularit√© d'entra√Ænement.

## Acceptance Criteria

1. Syst√®me de streaks (jours cons√©cutifs) avec calcul automatique et persistance
2. Badges de progression (paliers) avec attribution automatique et galerie de visualisation
3. Syst√®me de rappels (notifications locales/email) avec configuration utilisateur (opt-in)
4. Interface de visualisation des r√©compenses avec animations et feedback

## Tasks / Subtasks

- [ ] Cr√©er la migration de base de donn√©es pour la gamification (AC: 1, 2, 3)
  - [ ] Cr√©er la table `user_streaks` avec current_streak, best_streak, last_activity_date
  - [ ] Cr√©er la table `badges` avec les d√©finitions de badges (paliers)
  - [ ] Cr√©er la table `user_badges` pour les badges gagn√©s par utilisateur
  - [ ] Cr√©er la table `notification_preferences` pour les pr√©f√©rences utilisateur
  - [ ] Ajouter les index pour les performances (user_id, badge_id, earned_at)
  - [ ] Cr√©er les fonctions PostgreSQL pour le calcul automatique des streaks
  - [ ] Cr√©er les triggers pour l'attribution automatique des badges
  - [ ] Activer les politiques RLS pour toutes les tables
- [ ] Impl√©menter le syst√®me de streaks (AC: 1)
  - [ ] Cr√©er le service `streakService.ts` avec calcul de streak
  - [ ] Impl√©menter la fonction de mise √† jour automatique du streak
  - [ ] Impl√©menter la d√©tection de rupture de streak
  - [ ] Cr√©er le hook `useStreak.ts` pour l'acc√®s au streak
  - [ ] Int√©grer le calcul du streak avec la validation de s√©ance
  - [ ] G√©rer le changement de fuseau horaire
  - [ ] Ajouter la persistance du streak en base de donn√©es
  - [ ] Impl√©menter le cache local pour les performances
- [ ] D√©velopper le syst√®me de badges (AC: 2)
  - [ ] Cr√©er le service `badgeService.ts` avec logique d'attribution
  - [ ] D√©finir les badges de paliers (5, 10, 25, 50, 100 s√©ances)
  - [ ] D√©finir les badges de streaks (7, 14, 30 jours)
  - [ ] D√©finir les badges de dur√©e (10h, 25h, 50h total)
  - [ ] Impl√©menter la logique de v√©rification des badges
  - [ ] Cr√©er le hook `useBadges.ts` pour l'acc√®s aux badges
  - [ ] Impl√©menter la notification de nouveau badge gagn√©
  - [ ] Ajouter les animations de c√©l√©bration
- [ ] Am√©liorer les composants de visualisation existants (AC: 4)
  - [ ] Am√©liorer `StreakCounter.tsx` avec animations et d√©tails
  - [ ] Am√©liorer `BadgeSystem.tsx` avec progression et c√©l√©brations
  - [ ] Cr√©er `BadgeGallery.tsx` pour la galerie compl√®te des badges
  - [ ] Cr√©er `BadgeProgress.tsx` pour la progression vers le prochain badge
  - [ ] Cr√©er `StreakCalendar.tsx` pour la vue calendrier du streak
  - [ ] Cr√©er `GamificationDashboard.tsx` pour le dashboard de gamification
  - [ ] Int√©grer les animations de c√©l√©bration (confetti, badges qui scintillent)
  - [ ] Ajouter les sons de r√©compense (optionnels, opt-in)
- [ ] Impl√©menter le syst√®me de notifications (AC: 3)
  - [ ] Cr√©er le service `notificationService.ts` pour les notifications
  - [ ] Impl√©menter les notifications push locales (Web Notifications API)
  - [ ] Impl√©menter les notifications par email (via Supabase Edge Functions)
  - [ ] Cr√©er le composant `NotificationSettings.tsx` pour la configuration
  - [ ] Cr√©er le composant `ReminderModal.tsx` pour la premi√®re configuration
  - [ ] Impl√©menter le hook `useNotifications.ts` pour la gestion d'√©tat
  - [ ] G√©rer les permissions de notifications (demande opt-in)
  - [ ] Impl√©menter le scheduling des rappels
  - [ ] Ajouter la logique d'envoi diff√©r√© (temps optimal)
  - [ ] G√©rer les time zones pour les rappels
  - [ ] Impl√©menter la d√©sactivation/r√©activation des rappels
  - [ ] Ajouter les templates de rappels motivants
- [ ] Cr√©er l'Edge Function pour les notifications email (AC: 3)
  - [ ] Cr√©er `send-reminder-email` Edge Function
  - [ ] Impl√©menter le template d'email de rappel
  - [ ] Ajouter la logique de scheduling (cron job)
  - [ ] G√©rer les pr√©f√©rences utilisateur (opt-out)
  - [ ] Ajouter le tracking des emails envoy√©s
  - [ ] Impl√©menter la limitation de fr√©quence (rate limiting)
- [ ] Int√©grer la gamification dans le parcours utilisateur (AC: 1, 2, 4)
  - [ ] Afficher le streak sur le dashboard principal
  - [ ] Afficher les badges r√©cemment gagn√©s sur le dashboard
  - [ ] Ajouter une notification toast lors de l'obtention d'un badge
  - [ ] Cr√©er une page d√©di√©e `/gamification` avec tous les d√©tails
  - [ ] Ajouter un lien vers la gamification dans la navigation
  - [ ] Int√©grer les r√©compenses dans le flux de validation de s√©ance
  - [ ] Ajouter les badges au profil utilisateur
- [ ] Cr√©er les tests unitaires (AC: 1, 2, 3, 4)
  - [ ] Tests pour le calcul de streak (journalier, cons√©cutif, rupture)
  - [ ] Tests pour l'attribution automatique des badges
  - [ ] Tests pour les pr√©f√©rences de notifications
  - [ ] Tests pour le service de notifications (mock)
  - [ ] Tests pour les hooks (useStreak, useBadges, useNotifications)
  - [ ] Tests pour les composants de visualisation
  - [ ] Tests pour la d√©tection des paliers
  - [ ] Tests de performance pour les calculs
- [ ] Cr√©er les tests d'int√©gration (AC: 1, 2, 3, 4)
  - [ ] Tests de bout-en-bout pour le calcul du streak
  - [ ] Tests de bout-en-bout pour l'attribution des badges
  - [ ] Tests d'int√©gration avec Supabase
  - [ ] Tests des notifications push (permissions)
  - [ ] Tests des Edge Functions de notification
  - [ ] Tests du flux complet de gamification
  - [ ] Tests de la persistance des donn√©es
  - [ ] Tests de la synchronisation multi-devices
- [ ] Cr√©er les tests E2E (AC: 1, 2, 3, 4)
  - [ ] Test du parcours complet de gamification
  - [ ] Test de l'obtention d'un premier badge
  - [ ] Test de la configuration des rappels
  - [ ] Test de la rupture et reprise du streak
  - [ ] Test de la galerie de badges
  - [ ] Test des animations de c√©l√©bration
  - [ ] Test responsive sur mobile
  - [ ] Test des notifications push

## Dev Notes

### Architecture Context

[Source: docs/architecture/03-data-models.md#gamification, docs/prd-v1.2-sport-mvp.md#FR8-FR9]

**Stack Frontend:**

- React 19 + TypeScript + Vite
- TanStack Query v5 pour la gestion d'√©tat serveur
- Radix UI + Tailwind CSS pour l'interface
- Zustand pour l'√©tat global de gamification
- React Hook Form + Zod pour les formulaires de configuration
- Web Notifications API pour les notifications locales
- Framer Motion pour les animations de c√©l√©bration

**Mod√®les de donn√©es:**

```typescript
// UserStreak - Suivi des streaks utilisateur
interface UserStreak {
  user_id: string;
  current_streak: number;
  best_streak: number;
  last_activity_date: Date;
  streak_updated_at: Date;
}

// Badge - D√©finitions des badges disponibles
interface Badge {
  id: string;
  name: string;
  description: string;
  icon: string;
  requirement_type: 'sessions' | 'streak' | 'duration';
  requirement_value: number;
  tier: 'bronze' | 'silver' | 'gold' | 'platinum';
  created_at: Date;
}

// UserBadge - Badges gagn√©s par utilisateur
interface UserBadge {
  id: string;
  user_id: string;
  badge_id: string;
  earned_at: Date;
  progress: number;
  notified: boolean;
}

// NotificationPreference - Pr√©f√©rences de notifications
interface NotificationPreference {
  user_id: string;
  email_enabled: boolean;
  push_enabled: boolean;
  reminder_time: string; // HH:MM format (ex: "18:00")
  reminder_days: number[]; // 0-6 (Sunday-Saturday)
  reminder_frequency: 'daily' | 'twice_weekly' | 'weekly';
  last_reminded_at: Date;
  timezone: string;
  created_at: Date;
  updated_at: Date;
}

// StreakHistory - Historique des streaks (optionnel pour analytics)
interface StreakHistory {
  id: string;
  user_id: string;
  streak_length: number;
  start_date: Date;
  end_date: Date;
  created_at: Date;
}
```

**Structure de composants:**

```
src/components/features/sport/
‚îú‚îÄ‚îÄ Gamification/
‚îÇ   ‚îú‚îÄ‚îÄ GamificationDashboard.tsx      # Dashboard principal
‚îÇ   ‚îú‚îÄ‚îÄ StreakCounter.tsx              # Composant de streak (am√©lior√©)
‚îÇ   ‚îú‚îÄ‚îÄ StreakCalendar.tsx             # Calendrier visuel du streak
‚îÇ   ‚îú‚îÄ‚îÄ BadgeSystem.tsx                # Syst√®me de badges (am√©lior√©)
‚îÇ   ‚îú‚îÄ‚îÄ BadgeGallery.tsx               # Galerie de tous les badges
‚îÇ   ‚îú‚îÄ‚îÄ BadgeProgress.tsx              # Progression vers badges
‚îÇ   ‚îú‚îÄ‚îÄ BadgeEarnedModal.tsx           # Modal de c√©l√©bration nouveau badge
‚îÇ   ‚îú‚îÄ‚îÄ NotificationSettings.tsx       # Configuration des notifications
‚îÇ   ‚îú‚îÄ‚îÄ ReminderModal.tsx              # Modal de configuration initiale
‚îÇ   ‚îî‚îÄ‚îÄ CelebrationAnimation.tsx       # Animations de c√©l√©bration
```

**Hooks sp√©cialis√©s:**

```typescript
// Hook pour la gestion des streaks
function useStreak() {
  return {
    currentStreak: number;
    bestStreak: number;
    lastActivityDate: Date;
    isStreakActive: boolean;
    updateStreak: (date: Date) => Promise<void>;
    isLoading: boolean;
    error: Error | null;
  };
}

// Hook pour la gestion des badges
function useBadges() {
  return {
    earnedBadges: Badge[];
    availableBadges: Badge[];
    nextBadgeProgress: BadgeProgress;
    checkAndAwardBadges: () => Promise<Badge[]>;
    isLoading: boolean;
    error: Error | null;
  };
}

// Hook pour la gestion des notifications
function useNotifications() {
  return {
    preferences: NotificationPreference;
    updatePreferences: (prefs: Partial<NotificationPreference>) => Promise<void>;
    requestPermission: () => Promise<boolean>;
    scheduleReminder: (time: string) => Promise<void>;
    cancelReminders: () => Promise<void>;
    hasPermission: boolean;
    isLoading: boolean;
    error: Error | null;
  };
}
```

**Services:**

```typescript
// streakService.ts - Gestion des streaks
export const streakService = {
  // Calculer le streak actuel
  calculateCurrentStreak: async (userId: string): Promise<StreakData> => {
    // Logique de calcul bas√©e sur les s√©ances compl√©t√©es
  },

  // Mettre √† jour le streak apr√®s une s√©ance
  updateStreakAfterSession: async (userId: string, sessionDate: Date): Promise<StreakData> => {
    // Mise √† jour automatique du streak
  },

  // V√©rifier si le streak est maintenu
  checkStreakStatus: async (userId: string): Promise<boolean> => {
    // V√©rification journali√®re
  },

  // R√©cup√©rer l'historique du streak
  getStreakHistory: async (userId: string): Promise<StreakHistory[]> => {
    // Historique complet
  }
};

// badgeService.ts - Gestion des badges
export const badgeService = {
  // D√©finir les badges disponibles
  getBadgeDefinitions: (): Badge[] => {
    // Liste compl√®te des badges
  },

  // V√©rifier et attribuer les nouveaux badges
  checkAndAwardBadges: async (userId: string): Promise<Badge[]> => {
    // V√©rification apr√®s validation de s√©ance
  },

  // Calculer la progression vers le prochain badge
  calculateBadgeProgress: async (userId: string): Promise<BadgeProgress> => {
    // Progression vers paliers
  },

  // R√©cup√©rer les badges gagn√©s
  getEarnedBadges: async (userId: string): Promise<UserBadge[]> => {
    // Liste des badges gagn√©s
  }
};

// notificationService.ts - Gestion des notifications
export const notificationService = {
  // Demander la permission pour les notifications
  requestPermission: async (): Promise<boolean> => {
    // Permission Web Notifications API
  },

  // Envoyer une notification locale
  sendLocalNotification: (title: string, body: string): void => {
    // Notification push locale
  },

  // Programmer un rappel
  scheduleReminder: async (userId: string, preferences: NotificationPreference): Promise<void> => {
    // Scheduling via Edge Function
  },

  // Annuler les rappels
  cancelReminders: async (userId: string): Promise<void> => {
    // Annulation des rappels
  },

  // Envoyer un email de rappel
  sendReminderEmail: async (userId: string, email: string): Promise<void> => {
    // Via Edge Function Supabase
  },

  // G√©n√©rer un template de rappel motivant
  generateReminderTemplate: (userName: string, streak: number): string => {
    // Templates personnalis√©s
  }
};
```

**Requ√™tes Supabase optimis√©es:**

```typescript
// R√©cup√©ration du streak utilisateur
const getUserStreak = async (userId: string) => {
  const { data: streak } = await supabase
    .from('user_streaks')
    .select('*')
    .eq('user_id', userId)
    .single();

  return streak;
};

// Mise √† jour du streak
const updateStreak = async (userId: string, streakData: Partial<UserStreak>) => {
  const { data } = await supabase
    .from('user_streaks')
    .upsert({
      user_id: userId,
      ...streakData,
      streak_updated_at: new Date().toISOString(),
    })
    .select()
    .single();

  return data;
};

// R√©cup√©ration des badges gagn√©s avec d√©tails
const getEarnedBadges = async (userId: string) => {
  const { data: userBadges } = await supabase
    .from('user_badges')
    .select(
      `
      *,
      badge:badges (
        id, name, description, icon, requirement_type,
        requirement_value, tier
      )
    `
    )
    .eq('user_id', userId)
    .order('earned_at', { ascending: false });

  return userBadges;
};

// Attribution d'un nouveau badge
const awardBadge = async (userId: string, badgeId: string) => {
  const { data } = await supabase
    .from('user_badges')
    .insert({
      user_id: userId,
      badge_id: badgeId,
      earned_at: new Date().toISOString(),
      notified: false,
    })
    .select(
      `
      *,
      badge:badges (*)
    `
    )
    .single();

  return data;
};

// R√©cup√©ration des pr√©f√©rences de notifications
const getNotificationPreferences = async (userId: string) => {
  const { data: prefs } = await supabase
    .from('notification_preferences')
    .select('*')
    .eq('user_id', userId)
    .single();

  return prefs;
};

// Mise √† jour des pr√©f√©rences de notifications
const updateNotificationPreferences = async (
  userId: string,
  preferences: Partial<NotificationPreference>
) => {
  const { data } = await supabase
    .from('notification_preferences')
    .upsert({
      user_id: userId,
      ...preferences,
      updated_at: new Date().toISOString(),
    })
    .select()
    .single();

  return data;
};
```

**D√©finitions des badges:**

```typescript
// Badges de sessions (paliers)
const SESSION_BADGES = [
  {
    id: 'badge_sessions_5',
    name: 'D√©butant',
    description: 'Compl√©tez 5 s√©ances',
    icon: 'ü•â',
    requirement_type: 'sessions',
    requirement_value: 5,
    tier: 'bronze',
  },
  {
    id: 'badge_sessions_10',
    name: 'Motiv√©',
    description: 'Compl√©tez 10 s√©ances',
    icon: 'ü•à',
    requirement_type: 'sessions',
    requirement_value: 10,
    tier: 'silver',
  },
  {
    id: 'badge_sessions_25',
    name: 'Assidu',
    description: 'Compl√©tez 25 s√©ances',
    icon: 'ü•á',
    requirement_type: 'sessions',
    requirement_value: 25,
    tier: 'gold',
  },
  {
    id: 'badge_sessions_50',
    name: 'Champion',
    description: 'Compl√©tez 50 s√©ances',
    icon: 'üèÜ',
    requirement_type: 'sessions',
    requirement_value: 50,
    tier: 'platinum',
  },
  {
    id: 'badge_sessions_100',
    name: 'L√©gende',
    description: 'Compl√©tez 100 s√©ances',
    icon: 'üëë',
    requirement_type: 'sessions',
    requirement_value: 100,
    tier: 'platinum',
  },
];

// Badges de streaks
const STREAK_BADGES = [
  {
    id: 'badge_streak_7',
    name: 'Une Semaine',
    description: '7 jours cons√©cutifs',
    icon: 'üî•',
    requirement_type: 'streak',
    requirement_value: 7,
    tier: 'bronze',
  },
  {
    id: 'badge_streak_14',
    name: 'Deux Semaines',
    description: '14 jours cons√©cutifs',
    icon: 'üí™',
    requirement_type: 'streak',
    requirement_value: 14,
    tier: 'silver',
  },
  {
    id: 'badge_streak_30',
    name: 'Un Mois',
    description: '30 jours cons√©cutifs',
    icon: '‚ö°',
    requirement_type: 'streak',
    requirement_value: 30,
    tier: 'gold',
  },
];

// Badges de dur√©e
const DURATION_BADGES = [
  {
    id: 'badge_duration_600',
    name: '10 Heures',
    description: '10h d\'entra√Ænement total',
    icon: '‚è±Ô∏è',
    requirement_type: 'duration',
    requirement_value: 600, // minutes
    tier: 'bronze',
  },
  {
    id: 'badge_duration_1500',
    name: '25 Heures',
    description: '25h d\'entra√Ænement total',
    icon: 'üéØ',
    requirement_type: 'duration',
    requirement_value: 1500,
    tier: 'silver',
  },
  {
    id: 'badge_duration_3000',
    name: '50 Heures',
    description: '50h d\'entra√Ænement total',
    icon: 'üíé',
    requirement_type: 'duration',
    requirement_value: 3000,
    tier: 'gold',
  },
];
```

**Animations et feedback:**

```typescript
// Configuration des animations de c√©l√©bration
const celebrationConfig = {
  confetti: {
    duration: 3000,
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 },
  },
  badgeAnimation: {
    scale: [1, 1.2, 1],
    rotate: [0, 10, -10, 0],
    duration: 600,
  },
  streakAnimation: {
    flame: {
      scale: [1, 1.3, 1],
      opacity: [1, 0.8, 1],
      duration: 1000,
      repeat: Infinity,
    },
  },
};

// Notification toast lors de l'obtention d'un badge
const showBadgeEarnedToast = (badge: Badge) => {
  toast.success(
    <div className="flex items-center space-x-3">
      <span className="text-3xl">{badge.icon}</span>
      <div>
        <p className="font-semibold">Nouveau badge!</p>
        <p className="text-sm">{badge.name}</p>
      </div>
    </div>,
    {
      duration: 5000,
      position: 'top-center',
    }
  );
};
```

**Edge Function pour les notifications email:**

```typescript
// supabase/functions/send-reminder-email/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  const { userId, email, userName, currentStreak } = await req.json();

  // V√©rifier les pr√©f√©rences utilisateur
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  );

  const { data: prefs } = await supabase
    .from('notification_preferences')
    .select('*')
    .eq('user_id', userId)
    .single();

  if (!prefs?.email_enabled) {
    return new Response(JSON.stringify({ skipped: true }), { status: 200 });
  }

  // G√©n√©rer le template d'email personnalis√©
  const emailTemplate = generateReminderEmail(userName, currentStreak);

  // Envoyer l'email via service de votre choix
  // (Resend, SendGrid, etc.)

  // Logger l'envoi
  await supabase.from('notification_logs').insert({
    user_id: userId,
    type: 'email_reminder',
    sent_at: new Date().toISOString(),
  });

  return new Response(JSON.stringify({ success: true }), { status: 200 });
});

function generateReminderEmail(userName: string, currentStreak: number): string {
  const templates = [
    `Salut ${userName}! Ton streak de ${currentStreak} jours t'attend. Pr√™t pour une nouvelle s√©ance?`,
    `${userName}, maintiens ton √©lan! ${currentStreak} jours de suite, c'est impressionnant!`,
    `Hey ${userName}! Une petite s√©ance aujourd'hui pour continuer ton streak de ${currentStreak} jours?`,
  ];

  return templates[Math.floor(Math.random() * templates.length)];
}
```

### Testing Standards

[Source: docs/architecture/04-component-architecture.md#testing-requirements]

**Tests unitaires (Vitest):**

- Calcul du streak (cons√©cutif, rupture, reprise)
- Logique d'attribution des badges (paliers)
- Validation des pr√©f√©rences de notifications
- G√©n√©ration des templates de rappels
- V√©rification des permissions
- Calculs de progression vers badges
- Services (streakService, badgeService, notificationService)
- Hooks personnalis√©s (useStreak, useBadges, useNotifications)

**Tests d'int√©gration:**

- Attribution automatique des badges apr√®s validation de s√©ance
- Mise √† jour du streak en temps r√©el
- Persistance des pr√©f√©rences de notifications
- Synchronisation des donn√©es entre devices
- Int√©gration avec les Edge Functions
- Tests des requ√™tes Supabase avec RLS
- Tests du cache local

**Tests E2E (Playwright):**

- Flux complet de gamification (validation s√©ance ‚Üí badge gagn√©)
- Configuration des rappels avec permissions
- Visualisation de la galerie de badges
- Rupture et reprise d'un streak
- Animations de c√©l√©bration
- Tests responsive sur mobile
- Tests des notifications push
- Tests du calendrier de streak

**Configuration des tests:**

- Tests dans `src/__tests__/gamification/`
- Mocks pour les Web Notifications API
- Mocks pour les Edge Functions
- Donn√©es de test r√©alistes (streaks, badges)
- Tests de performance pour le calcul de streak
- Tests de charge pour les notifications

### File Locations

**Database:**
- Migration: `supabase/migrations/006_gamification_tables.sql`
- Edge Function: `supabase/functions/send-reminder-email/index.ts`
- Cron configuration: `supabase/functions/send-reminder-email/cron.yml`

**Pages:**
- Page gamification: `src/pages/sport/GamificationPage.tsx`

**Components:**
- Gamification: `src/components/features/sport/Gamification/`
- StreakCounter: `src/components/features/sport/StreakCounter.tsx` (am√©lioration)
- BadgeSystem: `src/components/features/sport/BadgeSystem.tsx` (am√©lioration)
- BadgeGallery: `src/components/features/sport/Gamification/BadgeGallery.tsx` (nouveau)
- NotificationSettings: `src/components/features/sport/Gamification/NotificationSettings.tsx` (nouveau)
- ReminderModal: `src/components/features/sport/Gamification/ReminderModal.tsx` (nouveau)

**Hooks:**
- useStreak: `src/hooks/useStreak.ts`
- useBadges: `src/hooks/useBadges.ts`
- useNotifications: `src/hooks/useNotifications.ts`

**Services:**
- streakService: `src/services/streakService.ts`
- badgeService: `src/services/badgeService.ts`
- notificationService: `src/services/notificationService.ts`

**Utils:**
- Badge definitions: `src/utils/badgeDefinitions.ts`
- Notification templates: `src/utils/notificationTemplates.ts`

**Types:**
- Types gamification: `src/types/gamification.ts`

**Tests:**
- Unit tests: `src/__tests__/unit/gamification/`
- Integration tests: `src/__tests__/integration/gamification/`
- E2E tests: `src/__tests__/e2e/gamification.spec.ts`

### Technical Constraints

- React 19 avec TypeScript strict
- TanStack Query pour la gestion d'√©tat serveur
- Web Notifications API pour les notifications locales (support Chrome, Firefox, Edge)
- Permissions utilisateur obligatoires pour les notifications push
- Supabase Edge Functions pour les emails (Deno runtime)
- Conformit√© RGPD: opt-in explicite pour les rappels
- Rate limiting pour les emails (max 1 par jour par utilisateur)
- Animations performantes (Framer Motion avec GPU acceleration)
- Support des time zones (intl API)
- Cache local pour les performances (localStorage + TanStack Query)
- Calculs de streak c√¥t√© serveur (PostgreSQL functions)
- RLS Supabase pour la s√©curit√© des donn√©es
- Tests de permissions navigateurs multiples
- Interface responsive mobile-first
- Accessibilit√© WCAG AA pour les notifications
- Fallback si notifications non support√©es

### Integration Points

**Avec Story 1.4 (Validation de s√©ance):**
- Mise √† jour automatique du streak apr√®s validation
- Attribution automatique des badges apr√®s validation
- D√©clenchement des animations de c√©l√©bration
- Mise √† jour du cache local

**Avec Story 1.5 (Historique et statistiques):**
- Affichage du streak sur le dashboard
- Affichage des badges r√©cemment gagn√©s
- Calcul des paliers pour les badges
- Int√©gration dans les statistiques globales

**Avec le profil utilisateur:**
- Configuration des pr√©f√©rences de notifications
- Affichage des badges dans le profil
- Historique des streaks
- Param√®tres de time zone

**Avec la navigation:**
- Ajout de l'onglet ou section "R√©compenses"
- Badge indicator sur l'ic√¥ne de navigation
- Quick access au streak depuis le dashboard

## Change Log

| Date       | Version | Description                   | Author   |
| ---------- | ------- | ----------------------------- | -------- |
| 2025-01-15 | 1.0     | Cr√©ation initiale de la story | John (PM) |

## Dev Agent Record

### Agent Model Used

_To be filled by development agent_

### Debug Log References

_To be filled during development_

### Completion Notes List

_To be filled during development_

### File List

_To be filled during development_

## QA Results

### Review Date

_To be filled by QA_

### Reviewed By

_To be filled by QA_

### Code Quality Assessment

_To be filled by QA_

### Refactoring Performed

_To be filled by QA_

### Compliance Check

- **Coding Standards**: _To be verified_
- **Project Structure**: _To be verified_
- **Testing Strategy**: _To be verified_
- **All ACs Met**: _To be verified_

### Improvements Checklist

- [ ] Cr√©er la migration de base de donn√©es pour la gamification
- [ ] Impl√©menter le syst√®me de streaks avec calcul automatique
- [ ] D√©velopper le syst√®me de badges avec attribution automatique
- [ ] Cr√©er les composants de visualisation (galerie, progression)
- [ ] Impl√©menter le syst√®me de notifications (push + email)
- [ ] Cr√©er l'Edge Function pour les emails de rappel
- [ ] Int√©grer la gamification dans le parcours utilisateur
- [ ] Ajouter les animations de c√©l√©bration
- [ ] Cr√©er les tests unitaires pour tous les services
- [ ] Cr√©er les tests d'int√©gration avec Supabase
- [ ] Cr√©er les tests E2E pour le parcours gamification
- [ ] V√©rifier la conformit√© RGPD (opt-in)
- [ ] Optimiser les performances des calculs
- [ ] Tester sur diff√©rents navigateurs et devices

### Security Review

_To be filled by QA_

### Performance Considerations

_To be filled by QA_

### Files Modified During Review

_To be filled by QA_

### Gate Status

_To be filled by QA_

### Recommended Status

_To be filled by QA_
